<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilador, entre aspas</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .tree ul {
            padding-top: 20px; 
            position: relative;
            transition: all 0.5s;
            -webkit-transition: all 0.5s;
            -moz-transition: all 0.5s;
        }
        .tree li {
            float: left;
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
            transition: all 0.5s;
            -webkit-transition: all 0.5s;
            -moz-transition: all 0.5s;
        }
        .tree li::before, .tree li::after {
            content: '';
            position: absolute; 
            top: 0; 
            right: 50%;
            border-top: 1px solid #ccc;
            width: 50%; 
            height: 20px;
        }
        .tree li::after {
            right: auto; 
            left: 50%;
            border-left: 1px solid #ccc;
        }
        .tree li:only-child::after, .tree li:only-child::before {
            display: none;
        }
        .tree li:only-child { 
            padding-top: 0;
        }
        .tree li:first-child::before, .tree li:last-child::after {
            border: 0 none;
        }
        .tree li:last-child::before {
            border-right: 1px solid #ccc;
            border-radius: 0 5px 0 0;
            -webkit-border-radius: 0 5px 0 0;
            -moz-border-radius: 0 5px 0 0;
        }
        .tree li:first-child::after {
            border-radius: 5px 0 0 0;
            -webkit-border-radius: 5px 0 0 0;
            -moz-border-radius: 5px 0 0 0;
        }
        .tree ul ul::before {
            content: '';
            position: absolute; 
            top: 0; 
            left: 50%;
            border-left: 1px solid #ccc;
            width: 0; 
            height: 20px;
        }
        .tree li a {
            border: 1px solid #ccc;
            padding: 5px 10px;
            text-decoration: none;
            color: #666;
            font-family: arial, verdana, tahoma;
            font-size: 11px;
            display: inline-block;
            border-radius: 5px;
            -webkit-border-radius: 5px;
            -moz-border-radius: 5px;
            transition: all 0.5s;
            -webkit-transition: all 0.5s;
            -moz-transition: all 0.5s;
        }
        .tree li a:hover, .tree li a:hover+ul li a {
            background: #c8e4f8; 
            color: #000; 
            border: 1px solid #94a0b4;
        }
        .tree li a:hover+ul li::after, 
        .tree li a:hover+ul li::before, 
        .tree li a:hover+ul::before, 
        .tree li a:hover+ul ul::before {
            border-color:  #94a0b4;
        }
        .tree li a.non-terminal {
            background-color: #ffa500;
        }
        .tree li a.terminal {
            background-color: #add8e6;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.10.6/brython.min.js"></script>
</head>
<body onload="brython()">
    <main>
        <textarea id="inputParagraph" placeholder="Type your input here!"></textarea>
        <button id="analyzeButton">Analyze</button>
        <div id="output"></div>
        <h2>Lexical Analysis</h2>
        <table>
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Token</th>
                </tr>
            </thead>
            <tbody id="tokenTableBody">
            </tbody>
        </table>
        <h2>Derivation Table</h2>
        <table>
            <thead>
                <tr>
                    <th>Step</th>
                    <th>Stack</th>
                    <th>Derivation</th>
                    <th>Current String</th>
                </tr>
            </thead>
            <tbody id="derivationTableBody">
            </tbody>
        </table>
        <h2>Parse Tree</h2>
        <div class="tree">
            <ul id="tree"></ul>
        </div>
    </main>

    <script type="text/python">
        from browser import document, alert

        # Define the parsing table based on the provided grammar from JFLAP
        parsing_table = {
            'E': {'(': ['T', 'X'], 'id': ['T', 'X']},
            'F': {'(': ['(', 'E', ')'], 'id': ['id']},
            'T': {'(': ['F', 'Y'], 'id': ['F', 'Y']},
            'X': {'+': ['+', 'T', 'X'], '$': ['ε'], ')': ['ε']},
            'Y': {'+': ['ε'], '*': ['*', 'F', 'Y'], '$': ['ε'], ')': ['ε']}
        }

        def lexical_analyzer(input):
            tokens = []
            i = 0
            token_steps = []
            while i < len(input):
                char = input[i]
                if char.isalpha():
                    id = char
                    i += 1
                    while i < len(input) and input[i].isalnum():
                        id += input[i]
                        i += 1
                    tokens.append('id')
                    token_steps.append({'position': i - len(id), 'token': 'id'})
                else:
                    if char in ['+', '*', '(', ')']:
                        tokens.append(char)
                        token_steps.append({'position': i, 'token': char})
                    elif char in [' ', '\t', '\n']:
                        pass  # skip whitespace
                    else:
                        return f"Lexical error at position {i}: unexpected character '{char}'"
                    i += 1
            tokens.append('$')
            token_steps.append({'position': i, 'token': '$'})
            display_token_table(token_steps)
            return tokens

        def parse(tokens):
            stack = ['$', 'E']  # Start symbol 'E'
            index = 0
            step_number = 0
            derivation_steps = [{'step': step_number, 'production': 'Start', 'current_string': 'E', 'stack': ' '.join(reversed(stack))}]
            parse_tree = {'value': 'E', 'children': []}
            parse_stack = [{'node': parse_tree, 'token': 'E'}]

            while len(stack) > 1 or index < len(tokens) - 1:
                top = stack.pop()
                token = tokens[index]
                current_parse_node = parse_stack.pop()
                if top in parsing_table and token in parsing_table[top]:
                    production = parsing_table[top][token]
                    stack.extend(reversed([x for x in production if x != 'ε']))
                    derivation_steps.append({'step': step_number, 'production': f"{top} → {' '.join(production)}", 'current_string': ''.join(stack), 'stack': ' '.join(reversed(stack))})
                    for symbol in reversed(production):
                        if symbol != 'ε':
                            new_node = {'value': symbol, 'children': []}
                            current_parse_node['node']['children'].append(new_node)
                            parse_stack.append({'node': new_node, 'token': symbol})
                elif top == token:
                    index += 1
                else:
                    return {'result': f"Syntax error: expected '{top}' but found '{token}' at position {index}", 'derivation_steps': derivation_steps, 'parse_tree': parse_tree}
                step_number += 1

            derivation_steps.append({'step': step_number + 1, 'production': 'End', 'current_string': ''.join(stack), 'stack': ' '.join(reversed(stack))})
            return {'result': "Accepted", 'derivation_steps': derivation_steps, 'parse_tree': parse_tree}

        def display_token_table(token_steps):
            table_body = document['tokenTableBody']
            table_body.clear()
            for step in token_steps:
                row = document.createElement('tr')
                position_cell = document.createElement('td')
                position_cell.text = str(step['position'])
                token_cell = document.createElement('td')
                token_cell.text = step['token']
                row <= position_cell
                row <= token_cell
                table_body <= row

        def display_derivation_table(derivation_steps):
            table_body = document['derivationTableBody']
            table_body.clear()
            for step in derivation_steps:
                row = document.createElement('tr')
                step_number_cell = document.createElement('td')
                step_number_cell.text = str(step['step'])
                stack_cell = document.createElement('td')
                stack_cell.text = step['stack']
                step_cell = document.createElement('td')
                step_cell.text = step['production']
                current_string_cell = document.createElement('td')
                current_string_cell.text = step['current_string']
                row <= step_number_cell
                row <= stack_cell
                row <= step_cell
                row <= current_string_cell
                table_body <= row

        def generate_tree_html(node):
            if not node:
                return ''

            css_class = 'non-terminal' if node['children'] else 'terminal'

            html = f'<li><a href="#" class="{css_class}">{node["value"]}</a>'
            if node['children']:
                html += '<ul>'
                for child in node['children']:
                    html += generate_tree_html(child)
                html += '</ul>'
            html += '</li>'
            return html

        def analyze_input(event):
            document['output'].clear()
            input_text = document['inputParagraph'].value.strip()
            if input_text:
                tokens = lexical_analyzer(input_text)
                if isinstance(tokens, str):
                    document['output'].text = tokens
                else:
                    result = parse(tokens)
                    document['output'].text = result['result']
                    if 'derivation_steps' in result:
                        display_derivation_table(result['derivation_steps'])
                    if result['result'] == "Accepted":
                        document['tree'].innerHTML = generate_tree_html(result['parse_tree'])

        document['analyzeButton'].bind('click', analyze_input)
    </script>
</body>
</html>